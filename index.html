<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ì•½ì† ì´í–‰ì„œ ì¹´ìš´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            overflow-x: hidden;
            zoom: 0.75;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header {
            background-color: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #333;
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .header h1::before {
            content: "ğŸ“Š";
            margin-right: 12px;
            font-size: 28px;
        }

        /* ì—‘ì…€ ìŠ¤íƒ€ì¼ íƒ­ ì˜ì—­ */
        .tab-container {
            margin: 10px 10px 0 10px;
            display: flex;
            justify-content: flex-start;
            background-color: #f5f7fa;
            padding-left: 15px;
            border-bottom: 1px solid #d1d5db;
        }

        .tab-nav {
            display: flex;
            gap: 0;
            margin-bottom: -1px;
        }

        .grade-tab {
            padding: 8px 20px;
            border: 1px solid #d1d5db;
            border-bottom: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            color: #374151;
            background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
            position: relative;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            margin-right: -1px;
        }

        .grade-tab:hover:not(.active) {
            background: linear-gradient(to bottom, #ffffff 0%, #f9fafb 100%);
            color: #111827;
        }

        .grade-tab.active {
            background: linear-gradient(to bottom, #fef2f2 0%, #fecaca 100%);
            color: #dc2626;
            border-bottom: 1px solid #fef2f2;
            z-index: 10;
            position: relative;
        }

        .grade-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: #fef2f2;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container {
            margin: 0 10px 10px 10px;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px;
            overflow: hidden;
        }

        .grade-content {
            display: none;
        }

        .grade-content.active {
            display: block;
        }

        .scroll-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            border-collapse: separate;
            border-spacing: 1px 18px;
            width: 100%;
            table-layout: fixed;
        }

        .table-container th, .table-container td {
            text-align: center;
            padding: 0;
            white-space: nowrap;
        }

        .class-header-cell, .student-header-cell, .data-cell {
            padding: 6px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .class-header-cell {
            font-size: 0.9rem;
            font-weight: 700;
            color: #1e293b;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            position: sticky;
            left: 0;
            z-index: 10;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            width: 45px;
            min-width: 45px;
        }

        .student-header-cell {
            width: 38px;
            min-width: 38px;
            font-weight: 600;
            font-size: 0.85rem;
            color: #475569;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .data-cell {
            width: 38px;
            min-width: 38px;
            color: #1e293b;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .data-cell:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: rgba(59, 130, 246, 0.3);
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            background: white;
            font-size: 18px !important;
        }

        .modal-content h3 {
            font-size: 24px !important;
        }

        .modal-content label {
            font-size: 20px !important;
        }

        .modal-content input[type="text"] {
            font-size: 18px !important;
        }

        .modal-content p {
            font-size: 18px !important;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        input[type="date"] {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input[type="date"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* í–‰ì—´ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
        .highlight-row {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.15) 100%) !important;
        }

        .highlight-col {
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.15) 100%) !important;
        }


        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .drag-drop-section {
            padding: 0 5px;
        }

        .drop-zone-container, .message-container, .action-container, .phase-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        /* í˜ì´ì¦ˆ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .phase-section {
            padding: 0 5px;
        }

        /* ë¯¸ë‹ˆ í˜ì´ì¦ˆ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .phase-mini-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
        }

        .phase-area {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px;
            min-height: 80px;
            font-size: 12px;
            line-height: 1.4;
        }

        .phase-area .empty-message {
            color: #9ca3af;
            text-align: center;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 64px;
        }

        .phase-area .message-content {
            white-space: pre-line;
        }

        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transition: all 0.3s ease;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drop-zone.drag-over {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .drop-zone-content {
            pointer-events: none;
        }

        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .drop-zone-text {
            font-size: 18px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
        }

        .drop-zone-subtext {
            font-size: 14px;
            color: #64748b;
            line-height: 1.5;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .message-controls {
            display: flex;
            gap: 8px;
        }

        .copy-btn, .clear-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .copy-btn {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .copy-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .clear-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .clear-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .message-area {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            background: #f8fafc;
            font-size: 16px;
            line-height: 1.6;
            color: #374151;
        }

        .empty-message {
            color: #9ca3af;
            text-align: center;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 160px;
        }

        .message-content {
            white-space: pre-line;
        }

        /* ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì…€ ìŠ¤íƒ€ì¼ */
        .data-cell.dragging {
            opacity: 0.5;
            transform: rotate(5deg) scale(0.9);
            z-index: 1000;
        }

        .data-cell[draggable="true"] {
            cursor: grab;
        }

        .data-cell[draggable="true"]:active {
            cursor: grabbing;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes dropSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .drop-zone.drop-success {
            animation: dropSuccess 0.6s ease;
        }
    </style>
</head>
<body>
    <!-- Firebase ì„¤ì • ëª¨ë‹¬ -->
    <div id="firebaseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-xl font-bold mb-4 text-center">Firebase ì„¤ì •</h2>
            <div class="space-y-4">
                <div>
                    <label for="firebaseApiKey" class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                    <input type="password" id="firebaseApiKey" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Firebase API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div>
                    <label for="firebaseProjectId" class="block text-sm font-medium text-gray-700 mb-1">Project ID</label>
                    <input type="text" id="firebaseProjectId" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Firebase Project IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="flex space-x-3">
                    <button onclick="clearFirebaseSettings()" class="bg-red-500 text-white py-2 px-3 rounded-lg hover:bg-red-600 transition-colors text-sm">
                        ì´ˆê¸°í™”
                    </button>
                    <button onclick="saveFirebaseSettings()" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                        ì—°ê²°í•˜ê¸°
                    </button>
                </div>
                <div id="savedSettingsInfo" class="text-xs text-green-600 text-center hidden">
                    âœ… ì €ì¥ëœ ì„¤ì •ì´ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.
                </div>
                <p class="text-xs text-gray-500 text-center">
                    Firebase Consoleì—ì„œ API Keyì™€ Project IDë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </div>

    <!-- í—¤ë” -->
    <div class="header">
        <h1>í•™ìƒ ì•½ì† ì´í–‰ì„œ ì¹´ìš´í„°</h1>
        <button onclick="showFirebaseSettings()" class="text-sm bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
            Firebase ì„¤ì •
        </button>
    </div>

    <!-- í•™ë…„ë³„ íƒ­ -->
    <div class="tab-container">
        <nav class="tab-nav">
            <button id="grade1Tab" class="grade-tab active" data-grade="1">1í•™ë…„</button>
            <button id="grade2Tab" class="grade-tab" data-grade="2">2í•™ë…„</button>
            <button id="grade3Tab" class="grade-tab" data-grade="3">3í•™ë…„</button>
        </nav>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container">
        <!-- 1í•™ë…„ ë‚´ìš© -->
        <div id="grade1Content" class="grade-content active">
            <div class="scroll-container">
                <table id="counter-table-grade1" class="table-container">
                    <thead>
                        <tr>
                            <th class="class-header-cell">ë°˜</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 2í•™ë…„ ë‚´ìš© -->
        <div id="grade2Content" class="grade-content">
            <div class="scroll-container">
                <table id="counter-table-grade2" class="table-container">
                    <thead>
                        <tr>
                            <th class="class-header-cell">ë°˜</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 3í•™ë…„ ë‚´ìš© -->
        <div id="grade3Content" class="grade-content">
            <div class="scroll-container">
                <table id="counter-table-grade3" class="table-container">
                    <thead>
                        <tr>
                            <th class="class-header-cell">ë°˜</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì˜ì—­ -->
        <div class="drag-drop-section mt-8 flex gap-6">
            <!-- ì¢Œì¸¡: ë‹´ë‹¹êµì‚¬ ì•Œë¦¼ ì˜ì—­ (35%) -->
            <div class="drop-zone-container" style="flex: 0 0 35%">
                <div class="message-header">
                    <h3 class="text-lg font-bold text-gray-800">ğŸ“© ë‹´ë‹¹êµì‚¬ ì „ë‹¬ ë©”ì‹œì§€</h3>
                    <div class="message-controls">
                        <button id="clearBtn" class="clear-btn">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
                        <button id="copyBtn" class="copy-btn">ğŸ“‹ ë³µì‚¬</button>
                    </div>
                </div>
                <div id="dropZone" class="drop-zone">
                    <div id="dropZoneContent" class="drop-zone-content">
                        <div class="drop-zone-icon">ğŸ“¥</div>
                        <div class="drop-zone-text">ì—¬ê¸°ì— í•™ìƒì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                        <div class="drop-zone-subtext">ê·œì¹™ ìœ„ë°˜ì´ ë§ì€ í•™ìƒì„ ë“œë˜ê·¸í•´ì„œ ë†“ìœ¼ë©´<br>ë‹´ë‹¹êµì‚¬ ì „ë‹¬ ë©”ì‹œì§€ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤</div>
                    </div>
                    <div id="messageArea" class="message-area" style="display: none;">
                        <div class="empty-message">ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ í•™ìƒì„ ì¶”ê°€í•˜ë©´<br>ë©”ì‹œì§€ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>
            
            <!-- ìš°ì¸¡: ì¡°ì¹˜ ê´€ë¦¬ ì˜ì—­ (65%) -->
            <div class="action-container" style="flex: 1">
                <div class="message-header">
                    <h3 class="text-lg font-bold text-gray-800">ğŸ§¹ ì¡°ì¹˜ ê´€ë¦¬</h3>
                    <div class="message-controls">
                        <button id="actionClearBtn" class="clear-btn">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
                        <button id="actionCopyBtn" class="copy-btn">ğŸ“‹ ì „ì²´ ë³µì‚¬</button>
                    </div>
                </div>
                <div id="actionDropZone" class="drop-zone" style="min-height: 60px; padding: 12px;">
                    <div class="drop-zone-content">
                        <div class="drop-zone-icon" style="font-size: 24px; margin-bottom: 4px;">ğŸ§½</div>
                        <div class="drop-zone-text" style="font-size: 14px; margin-bottom: 2px;">ì¡°ì¹˜ ëŒ€ìƒìë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                        <div class="drop-zone-subtext" style="font-size: 11px;">7íšŒ/12íšŒ/15íšŒ ë„ë‹¬ ì‹œ ìë™ ë¶„ë¥˜</div>
                    </div>
                </div>
                
                <!-- 1,2,3ì°¨ êµ¬ì—­ì„ ì²­ì†Œ ì¡°ì¹˜ íŒ¨ë„ ë‚´ë¶€ì— ë°°ì¹˜ -->
                <div class="grid grid-cols-3 gap-4 mt-4">
                    <!-- 1ì°¨ êµ¬ì—­ -->
                    <div class="phase-mini-container">
                        <div class="mb-2">
                            <h4 class="text-sm font-bold text-gray-800">ğŸ¥‡ 1ì°¨(7íšŒ)</h4>
                        </div>
                        <div id="phase1Area" class="phase-area">
                            <div class="empty-message text-xs">1ì°¨ ì¡°ì¹˜ ëŒ€ìƒ ì—†ìŒ</div>
                        </div>
                    </div>
                    
                    <!-- 2ì°¨ êµ¬ì—­ -->
                    <div class="phase-mini-container">
                        <div class="mb-2">
                            <h4 class="text-sm font-bold text-gray-800">ğŸ¥ˆ 2ì°¨(12íšŒ)</h4>
                        </div>
                        <div id="phase2Area" class="phase-area">
                            <div class="empty-message text-xs">2ì°¨ ì¡°ì¹˜ ëŒ€ìƒ ì—†ìŒ</div>
                        </div>
                    </div>
                    
                    <!-- 3ì°¨ êµ¬ì—­ -->
                    <div class="phase-mini-container">
                        <div class="mb-2">
                            <h4 class="text-sm font-bold text-gray-800">ğŸ¥‰ 3ì°¨(15íšŒ)</h4>
                        </div>
                        <div id="phase3Area" class="phase-area">
                            <div class="empty-message text-xs">3ì°¨ ì¡°ì¹˜ ëŒ€ìƒ ì—†ìŒ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding/editing student data -->
    <div id="studentModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay p-4">
        <div class="modal-content bg-white p-6 w-full max-w-sm mx-auto shadow-lg">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4 text-center"></h3>
            
            <!-- Step 1: Checklist -->
            <div id="checklistStep">
                <p class="text-center text-gray-600 mb-4">ìœ„ë°˜ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                <div id="checklist-items" class="space-y-4">
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button id="cancelBtn" class="btn btn-secondary">ì·¨ì†Œ</button>
                    <button id="nextBtn" class="btn btn-primary">ë‹¤ìŒ</button>
                </div>
            </div>

            <!-- Step 2: Date Picker -->
            <div id="dateStep" class="hidden">
                <p class="text-center text-gray-600 mb-4">ë‚ ì§œë¥¼ ì§€ì •í•˜ì„¸ìš”.</p>
                <input type="date" id="dateInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <div class="mt-6 flex justify-between">
                    <button id="backBtn" class="btn btn-secondary">ë’¤ë¡œ</button>
                    <button id="finalSaveBtn" class="btn btn-success">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay p-4">
        <div class="modal-content bg-white p-6 w-full max-w-md mx-auto shadow-lg">
            <h3 id="historyModalTitle" class="text-xl font-bold text-gray-800 mb-4 text-center"></h3>
            <div id="historyList" class="max-h-80 overflow-y-auto space-y-4 pr-2">
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                 <button id="historyResetBtn" class="btn btn-warning">ê¸°ë¡ ì´ˆê¸°í™”</button>
                <button id="historyCloseBtn" class="btn btn-secondary">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Reset -->
    <div id="confirmModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay p-4">
        <div class="modal-content bg-white p-6 w-full max-w-sm mx-auto shadow-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">í™•ì¸</h3>
            <p id="confirmMessage" class="text-gray-600 text-center mb-6">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmCancelBtn" class="btn btn-secondary">ì·¨ì†Œ</button>
                <button id="confirmResetBtn" class="btn btn-danger">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Action Record Edit Modal -->
    <div id="actionEditModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay p-4">
        <div class="modal-content bg-white p-6 w-full max-w-sm mx-auto shadow-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">ì²­ì†Œ ê¸°ë¡ ìˆ˜ì •</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">í•™ìƒ ì •ë³´</label>
                    <p id="actionEditStudentInfo" class="text-gray-600"></p>
                </div>
                <div>
                    <label for="actionEditDate" class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                    <input type="date" id="actionEditDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì¡°ì¹˜ ì‚¬ìœ </label>
                    <p id="actionEditReason" class="text-gray-600"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="actionEditCancelBtn" class="btn btn-secondary">ì·¨ì†Œ</button>
                <button id="actionEditSaveBtn" class="btn btn-success">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Phase Edit Modal -->
    <div id="phaseEditModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay p-4">
        <div class="modal-content bg-white p-6 w-full max-w-sm mx-auto shadow-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">ì¡°ì¹˜ ë‚ ì§œ ìˆ˜ì •</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">í•™ìƒ ì •ë³´</label>
                    <p id="phaseEditStudentInfo" class="text-gray-600"></p>
                </div>
                <div>
                    <label for="phaseEditDate" class="block text-sm font-medium text-gray-700 mb-1">ì¡°ì¹˜ ë‚ ì§œ</label>
                    <input type="date" id="phaseEditDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì¡°ì¹˜ ì°¨ìˆ˜</label>
                    <p id="phaseEditLevel" class="text-gray-600"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="phaseEditCancelBtn" class="btn btn-secondary">ì·¨ì†Œ</button>
                <button id="phaseEditSaveBtn" class="btn btn-success">ì €ì¥</button>
            </div>
        </div>
    </div>


    <script>
        // Firebase ì„¤ì • (localStorageì—ì„œ ì½ì–´ì˜¤ê¸°)
        function initializeFirebase() {
            const apiKey = localStorage.getItem('firebaseApiKey');
            const projectId = localStorage.getItem('firebaseProjectId');

            if (!apiKey || !projectId) {
                showFirebaseSettings();
                return false;
            }

            const firebaseConfig = {
                apiKey: apiKey,
                authDomain: `${projectId}.firebaseapp.com`,
                databaseURL: `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                projectId: projectId,
                storageBucket: `${projectId}.firebasestorage.app`,
                messagingSenderId: "383693605457",
                appId: "1:383693605457:web:b5c75a08b0fcef08188670"
            };

            try {
                firebase.initializeApp(firebaseConfig);
                window.database = firebase.database();
                window.studentDataRef = database.ref('studentData');
                window.phaseDataRef = database.ref('phaseData');
                return true;
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showFirebaseSettings();
                return false;
            }
        }

        // Firebase ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤
        function showFirebaseSettings() {
            const modal = document.getElementById('firebaseModal');
            modal.style.display = 'flex';

            // ê¸°ì¡´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            const apiKey = localStorage.getItem('firebaseApiKey');
            const projectId = localStorage.getItem('firebaseProjectId');
            const savedSettingsInfo = document.getElementById('savedSettingsInfo');

            if (apiKey && projectId) {
                document.getElementById('firebaseApiKey').value = apiKey;
                document.getElementById('firebaseProjectId').value = projectId;
                savedSettingsInfo.classList.remove('hidden');
            } else {
                savedSettingsInfo.classList.add('hidden');
            }
        }

        // ì €ì¥ëœ ì„¤ì •ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadFirebaseSettingsFromStorage() {
            const apiKey = localStorage.getItem('firebaseApiKey');
            const projectId = localStorage.getItem('firebaseProjectId');

            if (apiKey && projectId) {
                // ì„¤ì • í•„ë“œì— ìë™ìœ¼ë¡œ ì…ë ¥
                document.getElementById('firebaseApiKey').value = apiKey;
                document.getElementById('firebaseProjectId').value = projectId;
                return true;
            }
            return false;
        }

        function saveFirebaseSettings() {
            const apiKey = document.getElementById('firebaseApiKey').value.trim();
            const projectId = document.getElementById('firebaseProjectId').value.trim();

            if (!apiKey || !projectId) {
                alert('API Keyì™€ Project IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // localStorageì— ì €ì¥
            localStorage.setItem('firebaseApiKey', apiKey);
            localStorage.setItem('firebaseProjectId', projectId);

            // Firebase ì¬ì´ˆê¸°í™”
            try {
                // ê¸°ì¡´ ì•±ì´ ìˆë‹¤ë©´ ì‚­ì œ
                if (firebase.apps.length > 0) {
                    firebase.apps.forEach(app => app.delete());
                }

                const success = initializeFirebase();
                if (success) {
                    document.getElementById('firebaseModal').style.display = 'none';
                    alert('Firebase ì„¤ì •ì´ ì €ì¥ë˜ê³  ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¤ìŒ ì ‘ì†ë¶€í„°ëŠ” ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.');
                    location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                }
            } catch (error) {
                console.error('Firebase ì„¤ì • ì˜¤ë¥˜:', error);
                alert('Firebase ì„¤ì •ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API Keyì™€ Project IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        function clearFirebaseSettings() {
            if (confirm('ì €ì¥ëœ Firebase ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // localStorageì—ì„œ ì„¤ì • ì‚­ì œ
                localStorage.removeItem('firebaseApiKey');
                localStorage.removeItem('firebaseProjectId');

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('firebaseApiKey').value = '';
                document.getElementById('firebaseProjectId').value = '';

                // ì €ì¥ëœ ì„¤ì • ì•Œë¦¼ ìˆ¨ê¸°ê¸°
                document.getElementById('savedSettingsInfo').classList.add('hidden');

                alert('ì €ì¥ëœ Firebase ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ì €ì¥ëœ Firebase ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            loadFirebaseSettingsFromStorage();

            // Firebase ì´ˆê¸°í™” ë¨¼ì € ì‹œë„
            if (!initializeFirebase()) {
                return; // Firebase ì„¤ì •ì´ ì—†ìœ¼ë©´ ì„¤ì • ëª¨ë‹¬ì´ í‘œì‹œë¨
            }
            const gradeConfig = {
                1: { classes: 7, students: 35 },
                2: { classes: 6, students: 35 },
                3: { classes: 5, students: 35 }
            };
            const violationItems = ['êµìš°ê´€ê³„', 'ìš©ëª¨ë³µì¥', 'ìˆ˜ì—…', 'ê¸°ë³¸ìƒí™œìŠµê´€', 'í•™ìƒì•ˆì „'];

            let currentGrade = 1;
            let studentData = {};
            let tempCheckedItems = [];
            let currentStudentInfo = { grade: null, classNum: null, studentNum: null };
            let confirmCallback = () => {};
            let messageList = [];
            let actionRecords = {};
            let phaseData = {
                1: { phase1: [], phase2: [], phase3: [] },
                2: { phase1: [], phase2: [], phase3: [] },
                3: { phase1: [], phase2: [], phase3: [] }
            };

            const studentModal = document.getElementById('studentModal');
            const modalTitle = document.getElementById('modalTitle');
            const checklistItemsContainer = document.getElementById('checklist-items');
            const checklistStep = document.getElementById('checklistStep');
            const dateStep = document.getElementById('dateStep');
            const cancelBtn = document.getElementById('cancelBtn');
            const nextBtn = document.getElementById('nextBtn');
            const backBtn = document.getElementById('backBtn');
            const finalSaveBtn = document.getElementById('finalSaveBtn');
            const dateInput = document.getElementById('dateInput');

            const historyModal = document.getElementById('historyModal');
            const historyModalTitle = document.getElementById('historyModalTitle');
            const historyList = document.getElementById('historyList');
            const historyCloseBtn = document.getElementById('historyCloseBtn');
            const historyResetBtn = document.getElementById('historyResetBtn');

            const confirmModal = document.getElementById('confirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmResetBtn = document.getElementById('confirmResetBtn');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');

            const dropZone = document.getElementById('dropZone');
            const dropZoneContent = document.getElementById('dropZoneContent');
            const messageArea = document.getElementById('messageArea');
            const copyBtn = document.getElementById('copyBtn');
            const clearBtn = document.getElementById('clearBtn');
            
            const actionDropZone = document.getElementById('actionDropZone');
            const actionCopyBtn = document.getElementById('actionCopyBtn');
            const actionClearBtn = document.getElementById('actionClearBtn');
            
            const actionEditModal = document.getElementById('actionEditModal');
            const actionEditStudentInfo = document.getElementById('actionEditStudentInfo');
            const actionEditDate = document.getElementById('actionEditDate');
            const actionEditReason = document.getElementById('actionEditReason');
            const actionEditCancelBtn = document.getElementById('actionEditCancelBtn');
            const actionEditSaveBtn = document.getElementById('actionEditSaveBtn');
            
            let currentEditKey = '';
            let currentEditIndex = -1;
            let currentEditPhase = 0;
            let currentEditPhaseIndex = -1;
            
            // Phase ê´€ë ¨ DOM ìš”ì†Œë“¤
            const phase1Area = document.getElementById('phase1Area');
            const phase2Area = document.getElementById('phase2Area');
            const phase3Area = document.getElementById('phase3Area');
            
            // Phase Edit Modal DOM ìš”ì†Œë“¤
            const phaseEditModal = document.getElementById('phaseEditModal');
            const phaseEditStudentInfo = document.getElementById('phaseEditStudentInfo');
            const phaseEditDate = document.getElementById('phaseEditDate');
            const phaseEditLevel = document.getElementById('phaseEditLevel');
            const phaseEditCancelBtn = document.getElementById('phaseEditCancelBtn');
            const phaseEditSaveBtn = document.getElementById('phaseEditSaveBtn');

            const createChecklistItems = () => {
                checklistItemsContainer.innerHTML = '';
                violationItems.forEach((item, index) => {
                    const id = index + 1;
                    const container = document.createElement('div');
                    container.className = 'space-y-2';
                    
                    container.innerHTML = 
                        '<div class="flex items-center">' +
                            '<input id="checkbox-' + id + '" type="checkbox" data-note-target="note-' + id + '" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 violation-checkbox">' +
                            '<label for="checkbox-' + id + '" class="ml-3 text-gray-700">' + item + '</label>' +
                        '</div>' +
                        '<input type="text" id="note-' + id + '" class="w-full p-1 border border-gray-200 rounded-md text-sm hidden transition-all" placeholder="êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">';
                    checklistItemsContainer.appendChild(container);
                });

                document.querySelectorAll('.violation-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', event => {
                        const noteInput = document.getElementById(event.target.dataset.noteTarget);
                        if (event.target.checked) {
                            noteInput.classList.remove('hidden');
                        } else {
                            noteInput.classList.add('hidden');
                            noteInput.value = '';
                        }
                    });
                });
            };

            const loadData = () => {
                studentDataRef.once('value', (snapshot) => {
                    studentData = snapshot.val() || {};
                    // ëª¨ë“  í•™ë…„ì˜ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                    Object.keys(gradeConfig).forEach(grade => {
                        updateTableFromData(parseInt(grade));
                    });
                }).catch((error) => {
                    console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                    studentData = {};
                });
            };

            const saveData = () => {
                studentDataRef.set(studentData).catch((error) => {
                    console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
                });
            };
            
            const savePhaseData = () => {
                phaseDataRef.set(phaseData).catch((error) => {
                    console.error('Phase ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
                });
            };
            
            const loadPhaseData = () => {
                phaseDataRef.once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        phaseData = data;
                        // í˜„ì¬ í•™ë…„ì˜ phase ì˜ì—­ ì—…ë°ì´íŠ¸
                        updateAllPhaseAreas();
                    }
                }).catch((error) => {
                    console.error('Phase ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                });
            };
            
            const getTodayDateString = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return year + '-' + month + '-' + day;
            };

            // í•´ë‹¹ í•™ìƒì´ í˜„ì¬ ë‹¨ê³„ì—ì„œ ì¡°ì¹˜ê°€ í•„ìš”í•œì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
            const checkStudentNeedsAction = (grade, classNum, studentNum, count) => {
                // 7íšŒ ë¯¸ë§Œì´ë©´ ì¡°ì¹˜ ë¶ˆí•„ìš”
                if (count < 7) {
                    return false;
                }
                
                if (!phaseData || !phaseData[grade]) {
                    // phaseDataê°€ ì—†ìœ¼ë©´ ì¡°ì¹˜ë˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ê°„ì£¼
                    return count >= 7;
                }
                
                const gradePhaseData = phaseData[grade];
                const studentInfo = grade + 'í•™ë…„ ' + classNum + 'ë°˜ ' + studentNum + 'ë²ˆ';
                
                // ê° ë‹¨ê³„ë³„ ì¡°ì¹˜ ì—¬ë¶€ í™•ì¸
                const isInPhase1 = (gradePhaseData.phase1 || []).some(item => item.includes(studentInfo));
                const isInPhase2 = (gradePhaseData.phase2 || []).some(item => item.includes(studentInfo));
                const isInPhase3 = (gradePhaseData.phase3 || []).some(item => item.includes(studentInfo));
                
                // ë‹¨ê³„ë³„ ì¡°ì¹˜ í•„ìš”ì„± íŒë‹¨
                if (count >= 15) {
                    // 15íšŒ ì´ìƒ: 3ì°¨ ì¡°ì¹˜ê°€ í•„ìš”í•˜ì§€ë§Œ ì•„ì§ 3ì°¨ì— ì—†ëŠ” ê²½ìš°
                    return !isInPhase3;
                } else if (count >= 12) {
                    // 12íšŒ ì´ìƒ: 2ì°¨ ì¡°ì¹˜ê°€ í•„ìš”í•˜ì§€ë§Œ ì•„ì§ 2ì°¨ì— ì—†ëŠ” ê²½ìš° (3ì°¨ëŠ” ì´ë¯¸ ì²˜ë¦¬ë¨ì„ ì˜ë¯¸)
                    return !isInPhase2 && !isInPhase3;
                } else if (count >= 7) {
                    // 7íšŒ ì´ìƒ: 1ì°¨ ì¡°ì¹˜ê°€ í•„ìš”í•˜ì§€ë§Œ ì•„ì§ 1ì°¨ì— ì—†ëŠ” ê²½ìš° (2ì°¨, 3ì°¨ëŠ” ì´ë¯¸ ì²˜ë¦¬ë¨ì„ ì˜ë¯¸)
                    return !isInPhase1 && !isInPhase2 && !isInPhase3;
                }
                
                return false;
            };

            const updateCellAppearance = (cell, count) => {
                // ê¸°ë³¸ í´ë˜ìŠ¤ ë° ìŠ¤íƒ€ì¼ ì œê±°
                cell.className = 'data-cell';
                cell.style.cssText = '';
                
                const grade = cell.getAttribute('data-grade');
                const classNum = cell.getAttribute('data-class');
                const studentNum = cell.getAttribute('data-student');
                
                // í•´ë‹¹ í•™ìƒì´ ì¡°ì¹˜ê°€ í•„ìš”í•œì§€ í™•ì¸ (7íšŒ ì´ìƒì´ë©´ì„œ ì•„ì§ ì¡°ì¹˜ë˜ì§€ ì•Šì€ ê²½ìš°)
                const needsAction = checkStudentNeedsAction(grade, classNum, studentNum, count);
                
                if (count === 0) {
                    cell.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)';
                    cell.style.color = '#64748b';
                } else if (count <= 7) {
                    cell.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%)';
                    cell.style.color = '#92400e';
                    cell.style.boxShadow = '0 4px 12px rgba(251, 191, 36, 0.3)';
                } else if (count <= 12) {
                    cell.style.background = 'linear-gradient(135deg, #fed7aa 0%, #fb923c 100%)';
                    cell.style.color = '#ea580c';
                    cell.style.boxShadow = '0 4px 12px rgba(249, 115, 22, 0.4)';
                } else if (count <= 15) {
                    cell.style.background = 'linear-gradient(135deg, #fecaca 0%, #f87171 100%)';
                    cell.style.color = '#ffffff';
                    cell.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.4)';
                } else {
                    cell.style.background = 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)';
                    cell.style.color = '#ffffff';
                    cell.style.boxShadow = '0 6px 16px rgba(185, 28, 28, 0.5)';
                    cell.style.transform = 'scale(1.02)';
                }
                
                // ì¡°ì¹˜ê°€ í•„ìš”í•œ í•™ìƒì¸ ê²½ìš° ì´ˆë¡ í…Œë‘ë¦¬ í‘œì‹œ (ì²´í¬ë§ˆí¬ ì—†ì´)
                if (needsAction) {
                    cell.style.border = '3px solid #10b981';
                    cell.style.position = 'relative';
                }
            };
            
            const updateTableFromData = (grade) => {
                const table = document.querySelector('#counter-table-grade' + grade);
                if (!table) return;
                
                table.querySelectorAll('.data-cell').forEach(cell => {
                    const gradeNum = cell.getAttribute('data-grade');
                    const classNum = cell.getAttribute('data-class');
                    const studentNum = cell.getAttribute('data-student');
                    const key = gradeNum + '-' + classNum + '-' + studentNum;
                    const violations = studentData[key] || [];
                    
                    const count = violations.length;
                    cell.textContent = count;
                    updateCellAppearance(cell, count);
                });
            };

            const createTable = (grade, numClasses, numStudents) => {
                const table = document.querySelector('#counter-table-grade' + grade);
                const tableHeadRow = table.querySelector('thead tr');
                const tableBody = table.querySelector('tbody');
                
                tableHeadRow.innerHTML = '<th class="class-header-cell">ë°˜</th>';
                tableBody.innerHTML = '';
                
                for (let i = 1; i <= numStudents; i++) {
                    const th = document.createElement('th');
                    const div = document.createElement('div');
                    div.textContent = i;
                    div.className = 'student-header-cell';
                    th.appendChild(div);
                    tableHeadRow.appendChild(th);
                }
                
                for (let i = 1; i <= numClasses; i++) {
                    const tr = document.createElement('tr');
                    const classLabelTh = document.createElement('th');
                    const classLabelDiv = document.createElement('div');
                    classLabelDiv.textContent = i + 'ë°˜';
                    classLabelDiv.className = 'class-header-cell';
                    classLabelTh.appendChild(classLabelDiv);
                    tr.appendChild(classLabelTh);
                    
                    for (let j = 1; j <= numStudents; j++) {
                        const td = document.createElement('td');
                        const studentBox = document.createElement('div');
                        studentBox.textContent = '0';
                        studentBox.className = 'data-cell';
                        studentBox.setAttribute('data-grade', grade);
                        studentBox.setAttribute('data-class', i);
                        studentBox.setAttribute('data-student', j);
                        
                        studentBox.addEventListener('click', openModal);
                        studentBox.addEventListener('contextmenu', openHistoryModal);
                        studentBox.addEventListener('mouseenter', highlightRowCol);
                        studentBox.addEventListener('mouseleave', removeHighlight);
                        
                        // ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
                        studentBox.setAttribute('draggable', 'true');
                        studentBox.addEventListener('dragstart', handleDragStart);
                        studentBox.addEventListener('dragend', handleDragEnd);
                        
                        td.appendChild(studentBox);
                        tr.appendChild(td);
                    }
                    tableBody.appendChild(tr);
                }
            };

            const openModal = (event) => {
                const cell = event.currentTarget;
                const grade = cell.getAttribute('data-grade');
                const classNum = cell.getAttribute('data-class');
                const studentNum = cell.getAttribute('data-student');
                
                if (!grade || !classNum || !studentNum) return;
                
                currentStudentInfo = { grade: grade, classNum: classNum, studentNum: studentNum };
                modalTitle.textContent = grade + 'í•™ë…„ ' + classNum + 'ë°˜ ' + studentNum + 'ë²ˆ í•™ìƒ';

                document.querySelectorAll('.violation-checkbox').forEach(cb => {
                    cb.checked = false;
                    const noteInput = document.getElementById(cb.dataset.noteTarget);
                    if(noteInput) {
                        noteInput.classList.add('hidden');
                        noteInput.value = '';
                    }
                });
                
                checklistStep.classList.remove('hidden');
                dateStep.classList.add('hidden');
                studentModal.classList.remove('hidden');
            };

            const closeModal = () => {
                studentModal.classList.add('hidden');
            };

            const handleNextClick = () => {
                tempCheckedItems = [];
                document.querySelectorAll('.violation-checkbox').forEach(checkbox => {
                    if (checkbox.checked) {
                        const noteInput = document.getElementById(checkbox.dataset.noteTarget);
                        tempCheckedItems.push({
                            name: checkbox.nextElementSibling.textContent,
                            note: noteInput.value || ''
                        });
                    }
                });
                checklistStep.classList.add('hidden');
                dateStep.classList.remove('hidden');
                dateInput.value = getTodayDateString();
            };

            const handleBackClick = () => {
                dateStep.classList.add('hidden');
                checklistStep.classList.remove('hidden');
            };
            
            const saveFinalData = () => {
                const grade = currentStudentInfo.grade;
                const classNum = currentStudentInfo.classNum;
                const studentNum = currentStudentInfo.studentNum;
                if (!grade || !classNum || !studentNum) return;

                const key = grade + '-' + classNum + '-' + studentNum;
                const selectedDate = dateInput.value;

                if (!selectedDate || tempCheckedItems.length === 0) {
                    closeModal();
                    return;
                }

                const newViolation = {
                    date: selectedDate,
                    items: tempCheckedItems
                };
                
                const violations = studentData[key] || [];
                violations.push(newViolation);
                studentData[key] = violations;

                saveData();
                updateTableFromData(grade);
                closeModal();
            };
            
            const handleDeleteViolation = (event) => {
                const key = historyModal.dataset.currentKey;
                const index = parseInt(event.target.dataset.index, 10);
                
                if (studentData[key] && studentData[key][index]) {
                     showConfirmation('ì´ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                        studentData[key].splice(index, 1);
                        if (studentData[key].length === 0) {
                            delete studentData[key];
                        }
                        saveData();
                        updateTableFromData(currentGrade);
                        renderHistoryList(key);
                        confirmModal.classList.add('hidden');
                    });
                }
            };

            const renderHistoryList = (key) => {
                historyList.innerHTML = '';
                const violations = studentData[key] || [];

                if (violations.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-500 text-center">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    const sortedViolations = violations.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    sortedViolations.forEach((violation, index) => {
                        const originalIndex = violations.indexOf(violation);
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'border-b pb-3';

                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'flex justify-between items-center mb-1';
                        
                        const dateP = document.createElement('p');
                        dateP.className = 'font-semibold text-gray-800';
                        dateP.textContent = violation.date;

                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.className = 'delete-violation-btn text-red-500 hover:text-red-700 font-bold text-xl px-2';
                        deleteBtn.dataset.index = originalIndex;

                        headerDiv.appendChild(dateP);
                        headerDiv.appendChild(deleteBtn);
                        itemDiv.appendChild(headerDiv);
                        
                        const itemsContainer = document.createElement('div');
                        itemsContainer.className = 'space-y-1 pl-2';
                        
                        violation.items.forEach(itemObject => {
                            const detailDiv = document.createElement('div');
                            let content = '<span class="font-medium text-gray-700">â€¢ ' + itemObject.name + '</span>';
                            if (itemObject.note) {
                                content += '<p class="pl-4 text-sm text-gray-500">' + itemObject.note + '</p>';
                            }
                            detailDiv.innerHTML = content;
                            itemsContainer.appendChild(detailDiv);
                        });

                        itemDiv.appendChild(itemsContainer);
                        historyList.appendChild(itemDiv);
                    });

                    document.querySelectorAll('.delete-violation-btn').forEach(btn => {
                        btn.addEventListener('click', handleDeleteViolation);
                    });
                }
            };
            
            const openHistoryModal = (event) => {
                event.preventDefault();
                const cell = event.currentTarget;
                const grade = cell.getAttribute('data-grade');
                const classNum = cell.getAttribute('data-class');
                const studentNum = cell.getAttribute('data-student');
                const key = grade + '-' + classNum + '-' + studentNum;

                historyModalTitle.textContent = grade + 'í•™ë…„ ' + classNum + 'ë°˜ ' + studentNum + 'ë²ˆ í•™ìƒ ê¸°ë¡';
                historyModal.dataset.currentKey = key;
                
                renderHistoryList(key);
                historyModal.classList.remove('hidden');
            };

            const closeHistoryModal = () => {
                historyModal.classList.add('hidden');
            };

            const showConfirmation = (message, onConfirm) => {
                confirmMessage.textContent = message;
                confirmCallback = onConfirm;
                confirmModal.classList.remove('hidden');
            };

            const highlightRowCol = (event) => {
                const cell = event.currentTarget;
                const grade = cell.getAttribute('data-grade');
                const classNum = cell.getAttribute('data-class');
                const studentNum = cell.getAttribute('data-student');
                
                const table = document.querySelector('#counter-table-grade' + grade);
                if (!table) return;
                
                // í–‰ í•˜ì´ë¼ì´íŠ¸ (í•´ë‹¹ ë°˜ì˜ ëª¨ë“  í•™ìƒ)
                table.querySelectorAll('[data-class="' + classNum + '"]').forEach(c => {
                    if (c.classList.contains('data-cell')) {
                        c.classList.add('highlight-row');
                    }
                });
                
                // ì—´ í•˜ì´ë¼ì´íŠ¸ (í•´ë‹¹ ë²ˆí˜¸ì˜ ëª¨ë“  ë°˜)
                table.querySelectorAll('[data-student="' + studentNum + '"]').forEach(c => {
                    if (c.classList.contains('data-cell')) {
                        c.classList.add('highlight-col');
                    }
                });
                
                // ë°˜ í—¤ë” í•˜ì´ë¼ì´íŠ¸
                table.querySelectorAll('.class-header-cell').forEach(header => {
                    if (header.textContent === classNum + 'ë°˜') {
                        header.classList.add('highlight-row');
                    }
                });
                
                // í•™ìƒ í—¤ë” í•˜ì´ë¼ì´íŠ¸
                const studentHeaders = table.querySelectorAll('.student-header-cell');
                if (studentHeaders[parseInt(studentNum) - 1]) {
                    studentHeaders[parseInt(studentNum) - 1].classList.add('highlight-col');
                }
            };

            const removeHighlight = (event) => {
                const cell = event.currentTarget;
                const grade = cell.getAttribute('data-grade');
                const table = document.querySelector('#counter-table-grade' + grade);
                if (!table) return;
                
                table.querySelectorAll('.highlight-row, .highlight-col').forEach(c => {
                    c.classList.remove('highlight-row', 'highlight-col');
                });
            };

            const switchGrade = (grade) => {
                currentGrade = grade;
                
                document.querySelectorAll('.grade-tab').forEach(tab => {
                    if (tab.dataset.grade == grade) {
                        tab.className = 'grade-tab active';
                    } else {
                        tab.className = 'grade-tab';
                    }
                });
                
                document.querySelectorAll('.grade-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById('grade' + grade + 'Content').classList.add('active');
                
                updateTableFromData(grade);
                updateAllPhaseAreas(); // Phase ì˜ì—­ë„ ì—…ë°ì´íŠ¸
            };

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ í•¨ìˆ˜ë“¤
            const handleDragStart = (event) => {
                const cell = event.currentTarget;
                cell.classList.add('dragging');
                
                const grade = cell.getAttribute('data-grade');
                const classNum = cell.getAttribute('data-class');
                const studentNum = cell.getAttribute('data-student');
                const key = grade + '-' + classNum + '-' + studentNum;
                const violations = studentData[key] || [];
                const count = violations.length;
                
                const dragData = {
                    grade: grade,
                    classNum: classNum,
                    studentNum: studentNum,
                    count: count
                };
                
                event.dataTransfer.setData('text/plain', JSON.stringify(dragData));
                event.dataTransfer.effectAllowed = 'copy';
            };

            const handleDragEnd = (event) => {
                event.currentTarget.classList.remove('dragging');
            };

            const handleDragOver = (event) => {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
                dropZone.classList.add('drag-over');
            };

            const handleDragLeave = (event) => {
                if (!dropZone.contains(event.relatedTarget)) {
                    dropZone.classList.remove('drag-over');
                }
            };

            const handleDrop = (event) => {
                event.preventDefault();
                dropZone.classList.remove('drag-over');
                dropZone.classList.add('drop-success');
                
                setTimeout(() => {
                    dropZone.classList.remove('drop-success');
                }, 600);

                try {
                    const dragData = JSON.parse(event.dataTransfer.getData('text/plain'));
                    const { grade, classNum, studentNum, count } = dragData;
                    
                    const message = grade + 'í•™ë…„ ' + classNum + 'ë°˜ ' + studentNum + 'ë²ˆ í•™ìƒì´ ì•½ì†ì´í–‰ì„œ ' + count + 'ì¥ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.';
                    messageList.push(message);
                    updateMessageArea();
                    
                } catch (error) {
                    console.error('ë“œë¡­ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                }
            };
            
            const handleActionDragOver = (event) => {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
                actionDropZone.classList.add('drag-over');
            };

            const handleActionDragLeave = (event) => {
                if (!actionDropZone.contains(event.relatedTarget)) {
                    actionDropZone.classList.remove('drag-over');
                }
            };

            const handleActionDrop = (event) => {
                event.preventDefault();
                actionDropZone.classList.remove('drag-over');
                actionDropZone.classList.add('drop-success');
                
                setTimeout(() => {
                    actionDropZone.classList.remove('drop-success');
                }, 600);

                try {
                    const dragData = JSON.parse(event.dataTransfer.getData('text/plain'));
                    const { grade, classNum, studentNum, count } = dragData;
                    
                    let phaseNum = 0;
                    let actionType = '';
                    let reason = '';
                    
                    if (count >= 7 && count < 12) {
                        phaseNum = 1;
                        actionType = '1ì¼ ì²­ì†Œ';
                        reason = '7íšŒ ë„ë‹¬';
                    } else if (count >= 12 && count < 15) {
                        phaseNum = 2;
                        actionType = '3ì¼ ì²­ì†Œ';
                        reason = '12íšŒ ë„ë‹¬';
                    } else if (count >= 15) {
                        phaseNum = 3;
                        actionType = '7ì¼ ì²­ì†Œ';
                        reason = '15íšŒ ë„ë‹¬';
                    } else {
                        showToast('ì•„ì§ ì²­ì†Œ ì¡°ì¹˜ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤. (7íšŒ ì´ìƒ í•„ìš”)');
                        return;
                    }
                    
                    // ê¸°ì¡´ ì²­ì†Œ ì¡°ì¹˜ ê¸°ë¡ì— ì¶”ê°€
                    const today = getTodayDateString();
                    const key = grade + '-' + classNum + '-' + studentNum;
                    
                    if (!actionRecords[key]) {
                        actionRecords[key] = [];
                    }
                    
                    const newRecord = {
                        date: today,
                        type: actionType,
                        reason: reason,
                        count: count
                    };
                    
                    actionRecords[key].push(newRecord);
                    
                    // í•´ë‹¹ phase ëª©ë¡ì—ë„ ì¶”ê°€ (ë‚ ì§œ í¬í•¨, í•™ë…„ë³„ë¡œ ì €ì¥)
                    const message = grade + 'í•™ë…„ ' + classNum + 'ë°˜ ' + studentNum + 'ë²ˆ (' + count + 'íšŒ) - ' + today;
                    const gradeNum = parseInt(grade);
                    const phaseKey = 'phase' + phaseNum;
                    
                    // phaseData êµ¬ì¡° í™•ì¸ ë° ì´ˆê¸°í™”
                    if (!phaseData[gradeNum]) {
                        phaseData[gradeNum] = { phase1: [], phase2: [], phase3: [] };
                    }
                    if (!phaseData[gradeNum][phaseKey]) {
                        phaseData[gradeNum][phaseKey] = [];
                    }
                    
                    if (!phaseData[gradeNum][phaseKey].includes(message)) {
                        phaseData[gradeNum][phaseKey].push(message);
                        savePhaseData(); // Firebaseì— ì €ì¥
                        
                        // í˜„ì¬ ë³´ê³  ìˆëŠ” í•™ë…„ì´ë©´ UI ì—…ë°ì´íŠ¸
                        if (gradeNum === currentGrade) {
                            updatePhaseArea(phaseNum, phaseData[gradeNum][phaseKey], 
                                phaseNum === 1 ? phase1Area : (phaseNum === 2 ? phase2Area : phase3Area)
                            );
                        }
                        
                        // í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì¡°ì¹˜ í‘œì‹œ ê°±ì‹ )
                        updateTableFromData(gradeNum);
                    }
                    
                    showToast(grade + 'í•™ë…„ ' + classNum + 'ë°˜ ' + studentNum + 'ë²ˆì´ ' + phaseNum + 'ì°¨ ì¡°ì¹˜ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                } catch (error) {
                    console.error('ì¡°ì¹˜ ë“œë¡­ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                }
            };

            const updateMessageArea = () => {
                if (messageList.length === 0) {
                    dropZoneContent.style.display = 'block';
                    messageArea.style.display = 'none';
                    copyBtn.disabled = true;
                    clearBtn.disabled = true;
                } else {
                    dropZoneContent.style.display = 'none';
                    messageArea.style.display = 'block';
                    const messageContent = messageList.join('\n');
                    messageArea.innerHTML = '<div class="message-content">' + messageContent + '</div>';
                    copyBtn.disabled = false;
                    clearBtn.disabled = false;
                }
            };
            
            
            const updatePhaseArea = (phaseNum, phaseList, phaseArea) => {
                // phaseListê°€ undefinedì´ê±°ë‚˜ nullì¸ ê²½ìš° ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬
                const safePhaseList = phaseList || [];
                
                if (safePhaseList.length === 0) {
                    phaseArea.innerHTML = '<div class="empty-message text-xs">' + phaseNum + 'ì°¨ ì¡°ì¹˜ ëŒ€ìƒ ì—†ìŒ</div>';
                } else {
                    let content = '<div class="space-y-1">';
                    safePhaseList.forEach((item, index) => {
                        content += '<div class="flex justify-between items-center bg-white border border-gray-200 rounded px-2 py-1">';
                        content += '<span class="text-xs flex-1 mr-2">' + item + '</span>';
                        content += '<div class="flex space-x-1">';
                        content += '<button class="edit-phase-btn text-blue-500 hover:text-blue-700 text-xs" data-phase="' + phaseNum + '" data-index="' + index + '">âœï¸</button>';
                        content += '<button class="delete-phase-btn text-red-500 hover:text-red-700 text-xs" data-phase="' + phaseNum + '" data-index="' + index + '">ğŸ—‘ï¸</button>';
                        content += '</div>';
                        content += '</div>';
                    });
                    content += '</div>';
                    
                    phaseArea.innerHTML = content;
                    
                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    phaseArea.querySelectorAll('.edit-phase-btn').forEach(btn => {
                        btn.addEventListener('click', handleEditPhase);
                    });
                    phaseArea.querySelectorAll('.delete-phase-btn').forEach(btn => {
                        btn.addEventListener('click', handleDeletePhase);
                    });
                }
            };
            
            const updateAllPhaseAreas = () => {
                if (!phaseData || !phaseData[currentGrade]) {
                    // ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                    if (!phaseData) phaseData = {};
                    if (!phaseData[currentGrade]) {
                        phaseData[currentGrade] = { phase1: [], phase2: [], phase3: [] };
                    }
                }
                
                const currentPhaseData = phaseData[currentGrade];
                updatePhaseArea(1, currentPhaseData.phase1, phase1Area);
                updatePhaseArea(2, currentPhaseData.phase2, phase2Area);
                updatePhaseArea(3, currentPhaseData.phase3, phase3Area);
            };

            const handleCopy = async () => {
                if (messageList.length === 0) return;
                
                const textToCopy = messageList.join('\n');
                
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    showToast('ë©”ì‹œì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } catch (error) {
                    // í´ë¦½ë³´ë“œ API ì‹¤íŒ¨ ì‹œ fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        showToast('ë©”ì‹œì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } catch (fallbackError) {
                        showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                    }
                    
                    document.body.removeChild(textArea);
                }
            };

            const handleClear = () => {
                if (messageList.length === 0) return;
                
                showConfirmation('ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                    messageList.length = 0;
                    updateMessageArea();
                    showToast('ë©”ì‹œì§€ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    confirmModal.classList.add('hidden');
                });
            };
            
            const handleActionCopy = async () => {
                // í˜„ì¬ í•™ë…„ì˜ ëª¨ë“  phase ëª©ë¡ì„ í•©ì³ì„œ ë³µì‚¬
                const currentPhaseData = phaseData[currentGrade];
                let allPhases = [];
                
                if (currentPhaseData.phase1.length > 0) {
                    allPhases.push('1ì°¨ ì¡°ì¹˜ ëŒ€ìƒì:');
                    allPhases.push(...currentPhaseData.phase1);
                    allPhases.push('');
                }
                if (currentPhaseData.phase2.length > 0) {
                    allPhases.push('2ì°¨ ì¡°ì¹˜ ëŒ€ìƒì:');
                    allPhases.push(...currentPhaseData.phase2);
                    allPhases.push('');
                }
                if (currentPhaseData.phase3.length > 0) {
                    allPhases.push('3ì°¨ ì¡°ì¹˜ ëŒ€ìƒì:');
                    allPhases.push(...currentPhaseData.phase3);
                    allPhases.push('');
                }
                
                if (allPhases.length === 0) {
                    showToast('ë³µì‚¬í•  ì¡°ì¹˜ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const textToCopy = currentGrade + 'í•™ë…„ ì¡°ì¹˜ ëª©ë¡:\n\n' + allPhases.join('\n').trim();
                
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    showToast(currentGrade + 'í•™ë…„ ì¡°ì¹˜ ëª©ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } catch (error) {
                    console.error('ë³µì‚¬ ì˜¤ë¥˜:', error);
                    showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            };

            const handleActionClear = () => {
                const currentPhaseData = phaseData[currentGrade];
                const hasData = currentPhaseData.phase1.length > 0 || currentPhaseData.phase2.length > 0 || currentPhaseData.phase3.length > 0;
                if (!hasData) return;
                
                showConfirmation(currentGrade + 'í•™ë…„ ëª¨ë“  ì¡°ì¹˜ ëª©ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                    currentPhaseData.phase1.length = 0;
                    currentPhaseData.phase2.length = 0;
                    currentPhaseData.phase3.length = 0;
                    savePhaseData(); // Firebaseì— ì €ì¥
                    
                    updateAllPhaseAreas();
                    
                    // í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì¡°ì¹˜ í‘œì‹œ ê°±ì‹ )
                    updateTableFromData(currentGrade);
                    
                    showToast(currentGrade + 'í•™ë…„ ëª¨ë“  ì¡°ì¹˜ ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    confirmModal.classList.add('hidden');
                });
            };
            
            
            const handleEditPhase = (event) => {
                const phaseNum = parseInt(event.target.dataset.phase);
                const index = parseInt(event.target.dataset.index);
                
                const currentPhaseData = phaseData[currentGrade];
                const phaseKey = 'phase' + phaseNum;
                const item = currentPhaseData[phaseKey][index];
                
                // "1í•™ë…„ 3ë°˜ 5ë²ˆ (8íšŒ) - 2025-09-09" í˜•ì‹ì—ì„œ ì •ë³´ ì¶”ì¶œ
                const parts = item.split(' - ');
                const studentInfo = parts[0];
                const currentDate = parts[1];
                
                currentEditPhase = phaseNum;
                currentEditPhaseIndex = index;
                
                phaseEditStudentInfo.textContent = studentInfo;
                phaseEditDate.value = currentDate;
                phaseEditLevel.textContent = phaseNum + 'ì°¨ ì¡°ì¹˜';
                
                phaseEditModal.classList.remove('hidden');
            };
            
            const handleDeletePhase = (event) => {
                const phaseNum = parseInt(event.target.dataset.phase);
                const index = parseInt(event.target.dataset.index);
                
                const currentPhaseData = phaseData[currentGrade];
                const phaseKey = 'phase' + phaseNum;
                const item = currentPhaseData[phaseKey][index];
                const studentInfo = item.split(' - ')[0];
                
                showConfirmation(studentInfo + 'ì˜ ' + phaseNum + 'ì°¨ ì¡°ì¹˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                    currentPhaseData[phaseKey].splice(index, 1);
                    savePhaseData(); // Firebaseì— ì €ì¥
                    updatePhaseArea(phaseNum, currentPhaseData[phaseKey],
                        phaseNum === 1 ? phase1Area : (phaseNum === 2 ? phase2Area : phase3Area)
                    );
                    // í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì¡°ì¹˜ í‘œì‹œ ê°±ì‹ )
                    updateTableFromData(currentGrade);
                    showToast(phaseNum + 'ì°¨ ì¡°ì¹˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    confirmModal.classList.add('hidden');
                });
            };
            
            const closePhaseEditModal = () => {
                phaseEditModal.classList.add('hidden');
                currentEditPhase = 0;
                currentEditPhaseIndex = -1;
            };
            
            const savePhaseEdit = () => {
                if (currentEditPhase > 0 && currentEditPhaseIndex >= 0) {
                    const currentPhaseData = phaseData[currentGrade];
                    const phaseKey = 'phase' + currentEditPhase;
                    const item = currentPhaseData[phaseKey][currentEditPhaseIndex];
                    const studentInfo = item.split(' - ')[0];
                    const newDate = phaseEditDate.value;
                    
                    currentPhaseData[phaseKey][currentEditPhaseIndex] = studentInfo + ' - ' + newDate;
                    savePhaseData(); // Firebaseì— ì €ì¥
                    
                    updatePhaseArea(currentEditPhase, currentPhaseData[phaseKey],
                        currentEditPhase === 1 ? phase1Area : (currentEditPhase === 2 ? phase2Area : phase3Area)
                    );
                    
                    // í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì¡°ì¹˜ í‘œì‹œ ê°±ì‹ )
                    updateTableFromData(currentGrade);
                    
                    showToast('ì¡°ì¹˜ ë‚ ì§œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closePhaseEditModal();
                }
            };
            
            const handleEditAction = (event) => {
                const key = event.target.dataset.key;
                const index = parseInt(event.target.dataset.index);
                const record = actionRecords[key][index];
                
                const keyParts = key.split('-');
                const grade = keyParts[0];
                const classNum = keyParts[1];
                const studentNum = keyParts[2];
                
                currentEditKey = key;
                currentEditIndex = index;
                
                actionEditStudentInfo.textContent = grade + 'í•™ë…„ ' + classNum + 'ë°˜ ' + studentNum + 'ë²ˆ';
                actionEditDate.value = record.date;
                actionEditReason.textContent = record.reason;
                
                actionEditModal.classList.remove('hidden');
            };
            
            const handleDeleteAction = (event) => {
                const key = event.target.dataset.key;
                const index = parseInt(event.target.dataset.index);
                
                const keyParts = key.split('-');
                const grade = keyParts[0];
                const classNum = keyParts[1];
                const studentNum = keyParts[2];
                
                showConfirmation(grade + 'í•™ë…„ ' + classNum + 'ë°˜ ' + studentNum + 'ë²ˆ í•™ìƒì˜ ì´ ì²­ì†Œ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                    actionRecords[key].splice(index, 1);
                    if (actionRecords[key].length === 0) {
                        delete actionRecords[key];
                    }
                    updateActionArea();
                    showToast('ì²­ì†Œ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    confirmModal.classList.add('hidden');
                });
            };
            
            const closeActionEditModal = () => {
                actionEditModal.classList.add('hidden');
                currentEditKey = '';
                currentEditIndex = -1;
            };
            
            const saveActionEdit = () => {
                if (currentEditKey && currentEditIndex >= 0) {
                    actionRecords[currentEditKey][currentEditIndex].date = actionEditDate.value;
                    updateActionArea();
                    showToast('ì²­ì†Œ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeActionEditModal();
                }
            };


            // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
            const showToast = (message) => {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    animation: slideIn 0.3s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            };

            const init = () => {
                Object.keys(gradeConfig).forEach(grade => {
                    const config = gradeConfig[grade];
                    createTable(parseInt(grade), config.classes, config.students);
                });

                createChecklistItems();
                loadData();
                loadPhaseData();
                
                // ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ì„¤ì •
                studentDataRef.on('value', (snapshot) => {
                    const newData = snapshot.val() || {};
                    // ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
                    if (JSON.stringify(studentData) !== JSON.stringify(newData)) {
                        studentData = newData;
                        // í˜„ì¬ ë³´ê³  ìˆëŠ” í•™ë…„ê³¼ ëª¨ë“  í•™ë…„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                        Object.keys(gradeConfig).forEach(grade => {
                            updateTableFromData(parseInt(grade));
                        });
                    }
                });
                
                // Phase ë°ì´í„° ì‹¤ì‹œê°„ ë™ê¸°í™” ì„¤ì •
                phaseDataRef.on('value', (snapshot) => {
                    const newPhaseData = snapshot.val();
                    if (newPhaseData && JSON.stringify(phaseData) !== JSON.stringify(newPhaseData)) {
                        phaseData = newPhaseData;
                        updateAllPhaseAreas();
                        // í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì¡°ì¹˜ í‘œì‹œ ê°±ì‹ )
                        updateTableFromData(currentGrade);
                    }
                });
                
                switchGrade(1);

                document.querySelectorAll('.grade-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const grade = parseInt(tab.dataset.grade);
                        switchGrade(grade);
                    });
                });
                
                
                nextBtn.addEventListener('click', handleNextClick);
                backBtn.addEventListener('click', handleBackClick);
                finalSaveBtn.addEventListener('click', saveFinalData);
                cancelBtn.addEventListener('click', closeModal);
                
                historyCloseBtn.addEventListener('click', closeHistoryModal);

                historyResetBtn.addEventListener('click', () => {
                    const key = historyModal.dataset.currentKey;
                    const keyParts = key.split('-');
                    const grade = keyParts[0];
                    const classNum = keyParts[1];
                    const studentNum = keyParts[2];
                    showConfirmation(grade + 'í•™ë…„ ' + classNum + 'ë°˜ ' + studentNum + 'ë²ˆ í•™ìƒì˜ ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                        delete studentData[key];
                        saveData();
                        updateTableFromData(currentGrade);
                        closeHistoryModal();
                        confirmModal.classList.add('hidden');
                    });
                });

                confirmResetBtn.addEventListener('click', () => {
                    if (typeof confirmCallback === 'function') {
                        confirmCallback();
                    }
                });
                confirmCancelBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
                
                // ì²­ì†Œ ê¸°ë¡ ìˆ˜ì • ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                actionEditCancelBtn.addEventListener('click', closeActionEditModal);
                actionEditSaveBtn.addEventListener('click', saveActionEdit);
                
                // Phase ìˆ˜ì • ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                phaseEditCancelBtn.addEventListener('click', closePhaseEditModal);
                phaseEditSaveBtn.addEventListener('click', savePhaseEdit);

                // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('drop', handleDrop);
                
                // ì²­ì†Œ ì¡°ì¹˜ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                actionDropZone.addEventListener('dragover', handleActionDragOver);
                actionDropZone.addEventListener('dragleave', handleActionDragLeave);
                actionDropZone.addEventListener('drop', handleActionDrop);
                
                // ë³µì‚¬ ë° ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                copyBtn.addEventListener('click', handleCopy);
                clearBtn.addEventListener('click', handleClear);
                actionCopyBtn.addEventListener('click', handleActionCopy);
                actionClearBtn.addEventListener('click', handleActionClear);
                
                // ì´ˆê¸° ë©”ì‹œì§€ ì˜ì—­ ìƒíƒœ ì„¤ì •
                updateMessageArea();
                
                // ì´ˆê¸° Phase ì˜ì—­ ìƒíƒœ ì„¤ì •
                updateAllPhaseAreas();

            };

            init();
        });
    </script>
</body>
</html>
